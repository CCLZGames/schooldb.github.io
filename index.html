<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>School Portal</title>

<style>
:root {
    --bg: #eef2ff;
    --card: #ffffff;
    --primary: #4f46e5;
    --accent: #22c55e;
    --text: #0f172a;
    --muted: #64748b;
    --border: #e5e7eb;
}

* {
    font-family: system-ui;
    box-sizing: border-box;
}

body {
    background: var(--bg);
    margin: 0;
    padding: 30px;
    color: var(--text);
}

.container {
    max-width: 900px;
    margin: auto;
}

.card {
    background: var(--card);
    border-radius: 18px;
    padding: 22px;
    margin-bottom: 20px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.08);
}

h2, h3 {
    margin-top: 0;
}

input, select {
    width: 100%;
    padding: 11px;
    margin-top: 8px;
    border-radius: 12px;
    border: 1px solid var(--border);
}

button {
    background: var(--primary);
    color: white;
    border: none;
    padding: 12px;
    border-radius: 12px;
    cursor: pointer;
    margin-top: 10px;
}

.stat {
    font-size: 42px;
    font-weight: 800;
    color: var(--primary);
}

.hidden { display: none; }
.small { color: var(--muted); font-size: 14px; }
.divider { height: 1px; background: var(--border); margin: 15px 0; }
</style>
</head>

<body>
<div class="container">

<h2>üè´ School Portal</h2>

<div class="card">
    <label>School</label>
    <select id="school"></select>

    <div class="divider"></div>

    <h3>Register</h3>
    <input id="r_user" placeholder="Username">
    <input id="r_pass" type="password" placeholder="Password">
    <input id="r_name" placeholder="Full name">
    <select id="r_role">
        <option value="student">Student</option>
        <option value="teacher">Teacher</option>
    </select>
    <select id="r_class"></select>
    <button onclick="register()">Create account</button>

    <div class="divider"></div>

    <h3>Login</h3>
    <input id="l_user" placeholder="Username">
    <input id="l_pass" type="password" placeholder="Password">
    <button onclick="login()">Login</button>

    <p id="msg" class="small"></p>
</div>

<div id="studentPanel" class="card hidden">
    <h3>üéì Student Dashboard</h3>
    <p class="small">House points</p>
    <div class="stat" id="s_points">0</div>

    <div class="divider"></div>

    <p class="small">Attendance</p>
    <div class="stat" id="s_attendance">N/A</div>
</div>

<div id="teacherPanel" class="hidden">
    <div class="card">
        <h3>üìÖ Attendance</h3>
        <select id="studentSelect"></select>
        <select id="status">
            <option>Present</option>
            <option>Late</option>
            <option>Absent</option>
        </select>
        <button onclick="mark()">Record</button>
    </div>

    <div class="card">
        <h3>‚≠ê House Points</h3>
        <input id="pts" type="number" placeholder="Points (+ or -)">
        <input id="reason" placeholder="Reason">
        <button onclick="points()">Update</button>
    </div>
</div>

</div>

<script src="db.js"></script>
<script>
let user;

function loadSchools() {
    school.innerHTML = "";
    DB.listDatabases().forEach(s => school.add(new Option(s, s)));
    loadClasses();
}
loadSchools();

school.onchange = loadClasses;

function loadClasses() {
    r_class.innerHTML = "";
    DB.getClasses(school.value).forEach(c => r_class.add(new Option(c, c)));
}

function register() {
    DB.addUser(school.value, {
        username: r_user.value,
        password: r_pass.value,
        fullName: r_name.value,
        role: r_role.value,
        class: r_class.value
    });
    msg.innerText = "Account created";
}

function login() {
    user = DB.login(school.value, l_user.value, l_pass.value);
    if (!user) return msg.innerText = "Invalid login";

    studentPanel.classList.add("hidden");
    teacherPanel.classList.add("hidden");

    user.role === "student" ? showStudent() : showTeacher();
}

function showStudent() {
    studentPanel.classList.remove("hidden");

    const pts = DB.getHousePoints(school.value)
        .filter(p => p.username === user.username)
        .reduce((a,b)=>a+b.points,0);

    const att = DB.getAttendance(school.value)
        .filter(a => a.username === user.username);

    const percent = att.length
        ? Math.round(att.filter(a=>a.status==="Present").length / att.length * 100)
        : "N/A";

    s_points.innerText = pts;
    s_attendance.innerText = percent + "%";
}

function showTeacher() {
    teacherPanel.classList.remove("hidden");
    studentSelect.innerHTML = "";

    DB.getUsers(school.value)
        .filter(u => u.role === "student" && u.class === user.class)
        .forEach(s => studentSelect.add(new Option(s.fullName, s.username)));
}

function mark() {
    DB.recordAttendance(school.value, {
        username: studentSelect.value,
        status: status.value,
        date: new Date().toISOString().split("T")[0]
    });
}

function points() {
    DB.addHousePoints(school.value, {
        username: studentSelect.value,
        points: Number(pts.value),
        reason: reason.value
    });
}
</script>
</body>
</html>
